ENV['RACK_ENV'] = 'test'
require 'rubygems'
require 'bundler/setup'
require 'test_helper'
require 'minitest/autorun'
require 'rack/test'
require 'server'
require 'pp'
require 'json'


class ServerUnitTests < MiniTest::Unit::TestCase
    include Rack::Test::Methods

    @@component = {:debug => {:uid => "debug", :query => 'debug', :title => "diagnostics", :subtitle => "Debug Component", :implementation => "Debug", :spec => nil}}

    def setup()
        @session = nil
        @api = build_api(@@component.to_yaml())
    end

    def app()
        app = create_stack(@api)
        return app
    end

    def test_returns_html_for_app()
        response = get('/app.html', {})
        assert_equal(200, response.status)
        assert_match(/<html>/, response.body)
    end

    def test_returns_api_json()
        response = get('/api/', {}, 'rack.session' => @session)
        assert_equal(200, response.status)
        result = JSON.parse(response.body, :symbolize_names => true)
        refute_nil(result)
    end

    def test_returns_public_files()
        response = get('/jqm.dex.css', {}, 'rack.session' => @session)
        assert_equal(200, response.status)
    end


end


